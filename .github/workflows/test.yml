name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Cache Verilator
      id: cache-verilator
      uses: actions/cache@v4
      with:
        path: |
          /usr/local/bin/verilator*
          /usr/local/share/verilator
        key: verilator-5.040-${{ runner.os }}

    - name: Install Verilator
      if: steps.cache-verilator.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y git perl python3 make autoconf g++ flex bison
        sudo apt-get install -y libfl2 libfl-dev zlib1g zlib1g-dev help2man || true
        git clone https://github.com/verilator/verilator
        cd verilator
        git checkout v5.040
        autoconf
        ./configure --disable-tcmalloc
        make -j$(nproc)
        sudo make install
        verilator --version

    - name: Install Python 3
      run: sudo apt update && sudo apt install -y python3 python3-pip

    - name: Install uv
      run: |
        if ! command -v uv &> /dev/null; then
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        fi

    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
        restore-keys: |
          venv-${{ runner.os }}-

    - name: Install dependencies
      run: uv sync

    - name: Run tests
      run: make test

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          sim_build/*/
          test/obj_dir*/
          .pytest_cache/
        retention-days: 7
